<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.park.monitoring.mapper.MetricLogMapper">
    <select id="selectAll" resultType="com.park.monitoring.model.MetricLog">
        SELECT *
        FROM metric_log;
    </select>
    <select id="selectLogAllByServerId" resultType="com.park.monitoring.model.MetricLog">
        SELECT *
        FROM metric_log
        where server_metric_fk=#{serverId};
    </select>

    <select id="selectLogAllByLatest" parameterType="int" resultType="com.park.monitoring.model.MetricLog">
        SELECT ml.server_metric_fk AS server_id,
            ml.log_id,
            ml.cpu_usage,
            ml.memory_usage,
            ml.created_date,
            IFNULL(ml.disk_usage1, null) AS disk_usage1,
            IFNULL(ml.disk_usage2, null) AS disk_usage2,
            IFNULL(ml.disk_usage3, null) AS disk_usage3,
            IFNULL(ml.disk_usage4, null) AS disk_usage4,
            IFNULL(ml.disk_total1, null) AS disk_total1,
            IFNULL(ml.disk_total2, null) AS disk_total2,
            IFNULL(ml.disk_total3, null) AS disk_total3,
            IFNULL(ml.disk_total4, null) AS disk_total4
        FROM metric_log ml
        WHERE ml.created_date = (
            SELECT MAX(sub_ml.created_date)
            FROM metric_log sub_ml
            WHERE sub_ml.server_metric_fk = ml.server_metric_fk
        );
    </select>
    <select id="selectLogHistory" parameterType="int" resultType="com.park.monitoring.model.MetricLog">
        SELECT
            server_metric_fk AS server_id,
            log_id,
            cpu_usage,
            memory_usage,
            created_date,
            IFNULL(disk_usage1, 'null') AS disk_usage1,
            IFNULL(disk_usage2, 'null') AS disk_usage2,
            IFNULL(disk_usage3, 'null') AS disk_usage3,
            IFNULL(disk_usage4, 'null') AS disk_usage4,
            IFNULL(disk_total1, 'null') AS disk_total1,
            IFNULL(disk_total2, 'null') AS disk_total2,
            IFNULL(disk_total3, 'null') AS disk_total3,
            IFNULL(disk_total4, 'null') AS disk_total4
        FROM
            metric_log
        WHERE
            server_metric_fk = #{serverId}
        ORDER BY
            created_date;
    </select>
    <insert id="insertLog" parameterType="com.park.monitoring.model.MetricLog">
        INSERT INTO metric_log (cpu_usage, memory_usage, server_metric_fk, created_date)
        VALUES (#{cpuUsage}, #{memoryUsage}, #{serverMetricFk}, #{createdDate});
    </insert>
<!--    <update id="updateLog" parameterType="com.park.monitoring.model.MetricLog">-->
<!--        UPDATE metric_log-->
<!--        SET cpu_usage=#{cpuUsage}, memory_usage=#{memoryUsage}-->
<!--        WHERE log_id=#{logId};-->
<!--    </update>-->
    <delete id="deleteLogBeforeTime" parameterType="java.time.LocalDateTime">
        DELETE FROM metric_log
        WHERE created_date
        <![CDATA[
        <
        ]]>
        #{timestamp};
    </delete>

</mapper>